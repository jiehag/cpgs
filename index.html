<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.5, maximum-scale=5.0">
    <title>餐厅菜单公示栏</title>
    <style>
        /* 保持原有CSS样式不变 */
        * {
            box-sizing: border-box;
        }
        
        html, body {
            margin: 0;
            padding: 0;
            background: #f0f0f0;
            height: 100%;
        }
        
        body {
            font-family: Arial, sans-serif;
            padding: 5px;
            -webkit-tap-highlight-color: transparent;
            min-width: 800px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        /* 全屏时的样式 */
        :fullscreen {
            background: #f0f0f0;
        }
        
        :-webkit-full-screen {
            background: #f0f0f0;
        }
        
        :-moz-full-screen {
            background: #f0f0f0;
        }
        
        :-ms-fullscreen {
            background: #f0f0f0;
        }
        
        .container {
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 10px;
            flex: 1;
        }
        
        /* 减小标题区域高度 */
        .header {
            background: #ff6b6b;
            color: white;
            padding: 8px 15px;
            text-align: center;
        }
        
        .title {
            font-size: 1.2rem;
            margin: 0 0 3px 0;
        }
        
        .date-display {
            font-size: 0.8rem;
            margin: 5px 0;
            background: rgba(255,255,255,0.2);
            padding: 3px 8px;
            border-radius: 12px;
            display: inline-block;
        }
        
        /* 按钮容器 - 全屏时隐藏 */
        .header-buttons {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            justify-content: center;
            transition: opacity 0.3s, max-height 0.3s;
            overflow: hidden;
            max-height: 40px;
            opacity: 1;
        }
        
        /* 全屏时隐藏按钮行 */
        body.fullscreen .header-buttons {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
        }
        
        .buttons {
            padding: 6px 10px;
            background: #f8f8f8;
            border-bottom: 1px solid #ddd;
            text-align: center;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 3px;
        }
        
        .btn {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            min-width: 80px;
            height: 28px;
            line-height: 1;
        }
        
        .admin-btn {
            background: #e74c3c;
        }
        
        .online-btn {
            background: #1abc9c;
        }
        
        .export-btn {
            background: #50c878;
        }
        
        .print-btn {
            background: #e67e22;
        }
        
        .lan-btn {
            background: #9b59b6;
        }
        
        .week-export-btn {
            background: #f39c12;
        }
        
        /* ===== 强制四列布局 ===== */
        .menu-container {
            padding: 10px;
            width: 100%;
            overflow-x: auto;
            flex: 1;
            min-height: 300px;
            transition: max-height 0.3s;
        }
        
        /* 全屏时增加菜单容器高度 */
        body.fullscreen .menu-container {
            max-height: calc(100vh - 100px) !important;
            padding: 15px;
        }
        
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            min-width: 800px;
        }
        
        /* 全屏时增加分类列的高度 */
        body.fullscreen .category-column {
            max-height: calc(100vh - 180px) !important;
            min-height: calc(100vh - 220px) !important;
        }
        
        .category-column {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 10px;
            min-height: 180px;
            max-height: 600px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .category-title {
            color: #ff6b6b;
            border-bottom: 2px solid #ff6b6b;
            padding-bottom: 4px;
            margin-bottom: 8px;
            font-size: 1rem;
            text-align: center;
            position: sticky;
            top: 0;
            background: #f8f9fa;
            z-index: 1;
        }
        
        .menu-item {
            background: white;
            padding: 6px 8px;
            margin-bottom: 4px;
            border-left: 3px solid #4a90e2;
            border-radius: 3px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 32px;
        }
        
        .item-name {
            font-weight: bold;
            flex: 1;
            padding-right: 4px;
            font-size: 0.9rem;
            word-break: break-word;
            line-height: 1.2;
        }
        
        .item-price {
            color: #ff6b6b;
            font-weight: bold;
            white-space: nowrap;
            font-size: 0.9rem;
            margin-left: 4px;
        }
        
        .no-menu {
            text-align: center;
            padding: 20px;
            color: #777;
            grid-column: 1 / 5;
            font-size: 0.9rem;
        }
        
        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            -webkit-transform: translate(-50%, -50%);
            background: white;
            padding: 15px;
            border-radius: 5px;
            width: 90%;
            max-width: 420px;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal-title {
            margin: 0 0 12px 0;
            color: #333;
            text-align: center;
            font-size: 1.1rem;
        }
        
        .modal-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }
        
        .modal-info {
            background: #e8f4fc;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 12px;
            border-left: 3px solid #3498db;
            font-size: 0.9rem;
        }
        
        .message {
            position: fixed;
            top: 15px;
            right: 15px;
            background: #50c878;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            display: none;
            z-index: 1001;
            max-width: 80%;
            word-break: break-word;
            font-size: 0.9rem;
        }
        
        .message.error {
            background: #ff6b6b;
        }
        
        .message.info {
            background: #3498db;
        }
        
        .message.warning {
            background: #f39c12;
        }
        
        .progress-bar {
            width: 100%;
            height: 5px;
            background: #f0f0f0;
            border-radius: 3px;
            margin: 8px 0;
            display: none;
        }
        
        .progress-fill {
            height: 100%;
            background: #4a90e2;
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s;
        }
        
        .progress-text {
            text-align: center;
            font-size: 0.85rem;
            color: #666;
            margin: 4px 0;
        }
        
        .url-info {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            margin: 8px 0;
            word-break: break-all;
            font-size: 0.85rem;
        }
        
        .url-test {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            margin: 8px 0;
            display: none;
        }
        
        .url-status {
            display: inline-block;
            padding: 1px 5px;
            border-radius: 2px;
            font-size: 0.75rem;
            margin-left: 4px;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
        }
        
        .error-status {
            background: #f8d7da;
            color: #721c24;
        }
        
        .loading {
            background: #fff3cd;
            color: #856404;
        }
        
        .tab-container {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }
        
        .tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            background: #f5f5f5;
            border-right: 1px solid #ddd;
            transition: all 0.3s;
        }
        
        .tab:last-child {
            border-right: none;
        }
        
        .tab.active {
            background: #3498db;
            color: white;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .lan-path-input {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .lan-path-input input {
            flex: 1;
        }
        
        .lan-path-input button {
            white-space: nowrap;
        }
        
        .lan-instruction {
            background: #f9f9f9;
            border-left: 3px solid #9b59b6;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.85rem;
            line-height: 1.4;
        }
        
        .lan-step {
            margin: 8px 0;
            padding-left: 5px;
        }
        
        .lan-step-number {
            display: inline-block;
            width: 20px;
            height: 20px;
            background: #9b59b6;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 20px;
            margin-right: 8px;
            font-size: 0.8rem;
        }
        
        /* 防止文字选中 */
        .btn, .menu-item {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        /* 手机端适配 - 保持4列但允许水平滚动 */
        @media (max-width: 800px) {
            body {
                padding: 3px;
                min-width: 0;
            }
            
            .container {
                margin-bottom: 6px;
            }
            
            .menu-container {
                padding: 8px;
            }
            
            .menu-grid {
                gap: 6px;
                min-width: 600px;
            }
            
            .category-column {
                padding: 6px;
                min-height: 160px;
                max-height: 500px;
            }
            
            .category-title {
                font-size: 0.9rem;
                padding-bottom: 3px;
                margin-bottom: 6px;
            }
            
            .menu-item {
                padding: 4px 6px;
                margin-bottom: 3px;
                min-height: 28px;
            }
            
            .item-name, .item-price {
                font-size: 0.8rem;
            }
            
            .btn {
                padding: 4px 6px;
                font-size: 0.75rem;
                min-width: 70px;
                height: 24px;
            }
            
            .buttons {
                padding: 5px;
                gap: 2px;
            }
            
            .header {
                padding: 6px 12px;
            }
            
            .title {
                font-size: 1rem;
            }
            
            .date-display {
                font-size: 0.75rem;
                padding: 2px 6px;
            }
            
            .modal-content {
                max-width: 95%;
                padding: 12px;
            }
            
            /* 手机端全屏调整 */
            body.fullscreen .menu-container {
                max-height: calc(100vh - 80px) !important;
                padding: 10px;
            }
            
            body.fullscreen .category-column {
                max-height: calc(100vh - 150px) !important;
                min-height: calc(100vh - 180px) !important;
            }
        }
        
        /* 超小屏幕处理 */
        @media (max-width: 600px) {
            .menu-grid {
                min-width: 500px;
                gap: 5px;
            }
            
            .category-column {
                padding: 5px;
                min-height: 140px;
                max-height: 450px;
            }
            
            .menu-item {
                padding: 3px 5px;
                margin-bottom: 2px;
                min-height: 26px;
            }
            
            .item-name, .item-price {
                font-size: 0.75rem;
            }
            
            .btn {
                padding: 3px 5px;
                font-size: 0.7rem;
                min-width: 65px;
                height: 22px;
            }
            
            .tab {
                padding: 8px 5px;
                font-size: 0.8rem;
            }
        }
        
        /* 打印样式 */
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .container {
                box-shadow: none;
                margin: 0;
            }
            
            .header, .buttons, .btn, .modal, .message {
                display: none !important;
            }
            
            .menu-container {
                padding: 0;
                overflow: visible !important;
            }
            
            .menu-grid {
                min-width: auto !important;
                gap: 10px;
            }
            
            .category-column {
                max-height: none !important;
                overflow: visible !important;
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="message" id="message">操作成功！</div>
    
    <div class="container">
        <div class="header">
            <h1 class="title">餐厅菜单公示栏</h1>
            <div class="date-display" id="current-date">正在加载...</div>
            <div class="header-buttons">
                <button class="btn" id="admin-btn" onclick="showPasswordModal()">管理登录</button>
                <button class="btn admin-btn" id="exit-btn" style="display:none;" onclick="exitAdmin()">退出管理</button>
                <button class="btn" id="fullscreen-btn" onclick="toggleFullscreen()">全屏显示</button>
            </div>
        </div>
        
        <div id="admin-controls" style="display:none;">
            <div class="buttons">
                <button class="btn" onclick="importExcel()">导入菜单</button>
                <button class="btn export-btn" onclick="exportExcel()">导出菜单</button>
                <button class="btn week-export-btn" onclick="exportWeekMenu()">导出周菜单</button>
                <button class="btn online-btn" onclick="showUpdateModal()">更新菜单</button>
                <button class="btn print-btn" onclick="window.print()">打印</button>
                <button class="btn" onclick="showChangePassword()">修改密码</button>
            </div>
            
            <div class="buttons">
                <input type="date" id="date-selector" onchange="changeDate(this.value)" style="padding:6px;border-radius:4px;border:1px solid #ddd;width:180px;max-width:100%;font-size:0.9rem;">
            </div>
        </div>
        
        <div class="menu-container" id="menu-container">
            <div class="no-menu">正在加载菜单数据...</div>
        </div>
    </div>
    
    <!-- 密码输入模态框 -->
    <div class="modal" id="password-modal">
        <div class="modal-content">
            <h3 class="modal-title">管理员登录</h3>
            <input type="password" class="modal-input" id="password-input" placeholder="输入密码" onkeypress="if(event.key=='Enter') checkPassword()">
            <div class="modal-buttons">
                <button class="btn" onclick="hideModal('password-modal')">取消</button>
                <button class="btn export-btn" onclick="checkPassword()">登录</button>
            </div>
        </div>
    </div>
    
    <!-- 更新菜单模态框（含在线和局域网选项） -->
    <div class="modal" id="update-modal">
        <div class="modal-content">
            <h3 class="modal-title">更新菜单</h3>
            
            <div class="tab-container">
                <div class="tab active" onclick="switchTab('online-tab')">在线更新</div>
                <div class="tab" onclick="switchTab('lan-tab')">局域网更新</div>
            </div>
            
            <!-- 在线更新标签页 -->
            <div id="online-tab" class="tab-content active">
                <div class="modal-info">
                    <strong><i class="fas fa-info-circle"></i> 在线更新说明：</strong>
                    <p style="margin:3px 0 0 0;font-size:0.85rem;">从互联网Excel文件获取最新菜单数据</p>
                </div>
                
                <div class="url-info">
                    <strong>默认数据源：</strong>
                    <p style="margin:3px 0;font-size:0.8rem;" id="default-url">https://raw.githubusercontent.com/jiehag/cp/refs/heads/main/menu_data.xlsx</p>
                </div>
                
                <div style="margin:12px 0;">
                    <label style="display:block;margin-bottom:3px;font-size:0.9rem;">自定义Excel链接：</label>
                    <input type="text" class="modal-input" id="custom-url" placeholder="输入Excel文件链接">
                    <div class="modal-buttons" style="margin-top:8px;">
                        <button class="btn" onclick="testCustomUrl()">测试链接</button>
                        <button class="btn export-btn" onclick="saveCustomUrl()">保存设置</button>
                    </div>
                </div>
                
                <div class="progress-bar" id="progress-container">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text" id="progress-text"></div>
                
                <div class="url-test" id="url-test">
                    <strong>连接测试结果：</strong>
                    <div id="test-result"></div>
                </div>
                
                <div style="margin:15px 0;">
                    <button class="btn online-btn" style="width:100%;margin-bottom:8px;" onclick="startOnlineUpdate()">
                        <i class="fas fa-cloud-download-alt"></i> 开始在线更新
                    </button>
                    
                    <button class="btn export-btn" style="width:100%;margin-bottom:8px;" onclick="downloadExcelFile()">
                        <i class="fas fa-file-download"></i> 下载Excel文件
                    </button>
                    
                    <button class="btn" style="width:100%;" onclick="manualImport()">
                        <i class="fas fa-file-upload"></i> 手动上传文件
                    </button>
                </div>
                
                <div class="modal-buttons">
                    <button class="btn" onclick="hideModal('update-modal')">关闭</button>
                    <button class="btn" onclick="resetToDefaultUrl()">重置为默认</button>
                </div>
            </div>
            
            <!-- 局域网更新标签页 -->
            <div id="lan-tab" class="tab-content">
                <div class="modal-info">
                    <strong><i class="fas fa-network-wired"></i> 局域网更新说明：</strong>
                    <p style="margin:3px 0 0 0;font-size:0.85rem;">从局域网共享文件夹获取Excel菜单文件</p>
                </div>
                
                <div class="lan-instruction">
                    <strong>使用方法：</strong>
                    <div class="lan-step">
                        <span class="lan-step-number">1</span> 将Excel文件放在局域网共享文件夹
                    </div>
                    <div class="lan-step">
                        <span class="lan-step-number">2</span> 在电脑上设置文件夹共享权限
                    </div>
                    <div class="lan-step">
                        <span class="lan-step-number">3</span> 输入共享文件路径，如：\\192.168.1.100\menu\menu.xlsx
                    </div>
                    <div class="lan-step">
                        <span class="lan-step-number">4</span> 点击"加载局域网文件"更新菜单
                    </div>
                </div>
                
                <div style="margin:12px 0;">
                    <label style="display:block;margin-bottom:3px;font-size:0.9rem;">局域网文件路径：</label>
                    <div class="lan-path-input">
                        <input type="text" class="modal-input" id="lan-path" placeholder="例如: \\电脑名\共享文件夹\菜单.xlsx">
                        <button class="btn" onclick="browseLanFile()">浏览</button>
                    </div>
                    
                    <div style="margin-top:10px;">
                        <label style="display:block;margin-bottom:3px;font-size:0.9rem;">或手动选择文件：</label>
                        <button class="btn lan-btn" style="width:100%;" onclick="selectLanFile()">
                            <i class="fas fa-folder-open"></i> 选择本地文件
                        </button>
                    </div>
                    
                    <div class="modal-buttons" style="margin-top:15px;">
                        <button class="btn" onclick="testLanPath()">测试路径</button>
                        <button class="btn lan-btn" onclick="saveLanPath()">保存路径</button>
                    </div>
                </div>
                
                <div class="progress-bar" id="lan-progress-container">
                    <div class="progress-fill" id="lan-progress-fill"></div>
                </div>
                <div class="progress-text" id="lan-progress-text"></div>
                
                <div class="url-test" id="lan-url-test">
                    <strong>连接测试结果：</strong>
                    <div id="lan-test-result"></div>
                </div>
                
                <div style="margin:15px 0;">
                    <button class="btn lan-btn" style="width:100%;margin-bottom:8px;" onclick="loadLanFile()">
                        <i class="fas fa-sync-alt"></i> 加载局域网文件
                    </button>
                    
                    <button class="btn export-btn" style="width:100%;margin-bottom:8px;" onclick="openLanFile()">
                        <i class="fas fa-external-link-alt"></i> 打开文件位置
                    </button>
                    
                    <button class="btn" style="width:100%;" onclick="showRecentLanFiles()">
                        <i class="fas fa-history"></i> 最近使用的文件
                    </button>
                </div>
                
                <div class="modal-buttons">
                    <button class="btn" onclick="hideModal('update-modal')">关闭</button>
                    <button class="btn" onclick="clearLanHistory()">清除历史</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 修改密码模态框 -->
    <div class="modal" id="change-password-modal">
        <div class="modal-content">
            <h3 class="modal-title">修改密码</h3>
            <input type="password" class="modal-input" id="old-password" placeholder="原密码">
            <input type="password" class="modal-input" id="new-password" placeholder="新密码(至少4位)">
            <div class="modal-buttons">
                <button class="btn" onclick="hideModal('change-password-modal')">取消</button>
                <button class="btn export-btn" onclick="saveNewPassword()">确认修改</button>
            </div>
        </div>
    </div>

    <!-- 最近文件列表模态框 -->
    <div class="modal" id="recent-files-modal">
        <div class="modal-content">
            <h3 class="modal-title">最近使用的文件</h3>
            <div id="recent-files-list" style="max-height:300px;overflow-y:auto;margin:15px 0;">
                <div style="text-align:center;padding:20px;color:#777;" id="no-recent-files">暂无最近使用的文件</div>
            </div>
            <div class="modal-buttons">
                <button class="btn" onclick="hideModal('recent-files-modal')">关闭</button>
                <button class="btn" onclick="clearLanHistory()">清除所有记录</button>
            </div>
        </div>
    </div>
    
    <!-- 周菜单选择模态框 -->
    <div class="modal" id="week-export-modal">
        <div class="modal-content">
            <h3 class="modal-title">导出周菜单</h3>
            <div class="modal-info">
                <p>请选择要导出的起始日期，系统将导出从该日期起连续7天的菜单数据。</p>
            </div>
            <div style="margin:15px 0;">
                <label style="display:block;margin-bottom:5px;font-size:0.9rem;">起始日期：</label>
                <input type="date" class="modal-input" id="week-start-date" value="">
                <div style="margin-top:10px;font-size:0.85rem;color:#666;">
                    将导出日期：<span id="week-date-range"></span>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn" onclick="hideModal('week-export-modal')">取消</button>
                <button class="btn week-export-btn" onclick="confirmExportWeekMenu()">导出周菜单</button>
            </div>
        </div>
    </div>

    <!-- 使用简单的Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <script>
        // ===== 全局变量和常量 =====
        var ADMIN_KEY = "admin123";
        var SYSTEM_KEY = "XGSQ364532890";
        var DEFAULT_EXCEL_URL = "https://raw.githubusercontent.com/jiehag/cp/refs/heads/main/menu_data.xlsx";
        var menuData = {};
        var isAdmin = false;
        var currentDate = "";
        var isFullscreen = false;
        var recentLanFiles = [];
        
        // ===== 定义固定的四个分类 =====
        var FIXED_CATEGORIES = ["主菜", "素菜", "主食", "汤品"];
        
        // ===== DOM元素引用 =====
        var messageEl = document.getElementById('message');
        var menuContainer = document.getElementById('menu-container');
        var currentDateEl = document.getElementById('current-date');
        var adminControls = document.getElementById('admin-controls');
        var adminBtn = document.getElementById('admin-btn');
        var exitBtn = document.getElementById('exit-btn');
        var dateSelector = document.getElementById('date-selector');
        var progressContainer = document.getElementById('progress-container');
        var progressFill = document.getElementById('progress-fill');
        var progressText = document.getElementById('progress-text');
        var urlTestDiv = document.getElementById('url-test');
        var testResultDiv = document.getElementById('test-result');
        var lanProgressContainer = document.getElementById('lan-progress-container');
        var lanProgressFill = document.getElementById('lan-progress-fill');
        var lanProgressText = document.getElementById('lan-progress-text');
        var lanUrlTestDiv = document.getElementById('lan-url-test');
        var lanTestResultDiv = document.getElementById('lan-test-result');
        var lanPathInput = document.getElementById('lan-path');
        var recentFilesList = document.getElementById('recent-files-list');
        var noRecentFiles = document.getElementById('no-recent-files');
        var fullscreenBtn = document.getElementById('fullscreen-btn');
        var weekStartDateInput = document.getElementById('week-start-date');
        var weekDateRangeSpan = document.getElementById('week-date-range');
        
        // ===== 基本工具函数 =====
        function showMessage(text, type) {
            messageEl.textContent = text;
            messageEl.className = 'message';
            
            if (type === 'error') {
                messageEl.classList.add('error');
            } else if (type === 'info') {
                messageEl.classList.add('info');
            } else if (type === 'warning') {
                messageEl.classList.add('warning');
            }
            
            messageEl.style.display = 'block';
            setTimeout(function() {
                messageEl.style.display = 'none';
            }, 3000);
        }
        
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }
        
        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function getTodayString() {
            var today = new Date();
            var year = today.getFullYear();
            var month = today.getMonth() + 1;
            var day = today.getDate();
            
            if (month < 10) month = '0' + month;
            if (day < 10) day = '0' + day;
            
            return year + '-' + month + '-' + day;
        }
        
        function formatDate(dateStr) {
            var date = new Date(dateStr);
            var weekdays = ['日', '一', '二', '三', '四', '五', '六'];
            return dateStr + ' 星期' + weekdays[date.getDay()];
        }
        
        function getWeekDates(startDateStr) {
            var dates = [];
            var startDate = new Date(startDateStr);
            
            for (var i = 0; i < 7; i++) {
                var date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                var year = date.getFullYear();
                var month = date.getMonth() + 1;
                var day = date.getDate();
                
                if (month < 10) month = '0' + month;
                if (day < 10) day = '0' + day;
                
                dates.push(year + '-' + month + '-' + day);
            }
            
            return dates;
        }
        
        // ===== 修复：安全的Excel工作表名称 =====
        function getSafeSheetName(dateStr, index) {
            var dateObj = new Date(dateStr);
            var weekdays = ['日', '一', '二', '三', '四', '五', '六'];
            var weekday = weekdays[dateObj.getDay()];
            var month = dateObj.getMonth() + 1;
            var day = dateObj.getDate();
            
            // 创建基础名称
            var baseName = (index + 1) + '.' + month + '-' + day + '周' + weekday;
            
            // 替换所有Excel不允许的字符
            var safeName = baseName
                .replace(/:/g, '：')  // 替换冒号
                .replace(/\//g, '-')  // 替换斜杠
                .replace(/\\/g, '-')  // 替换反斜杠
                .replace(/\?/g, '？')  // 替换问号
                .replace(/\*/g, '＊')  // 替换星号
                .replace(/\[/g, '【')  // 替换左方括号
                .replace(/\]/g, '】'); // 替换右方括号
            
            // Excel工作表名称最大31个字符
            if (safeName.length > 31) {
                safeName = safeName.substring(0, 31);
            }
            
            return safeName;
        }
        
        // ===== 智能菜品分类识别 =====
        function classifyMenuItem(itemName) {
            var name = String(itemName).toLowerCase();
            
            // 素菜识别
            if (name.includes('豆腐') || 
                name.includes('豆干') || 
                name.includes('白菜') || 
                name.includes('空心菜') || 
                name.includes('韭菜') || 
                name.includes('西兰花') || 
                name.includes('芹菜') ||
                name.includes('蒜蓉') ||
                name.includes('麻婆') ||
                name.includes('清炒')) {
                return '素菜';
            }
            
            // 主食识别
            if (name.includes('米饭') || 
                name.includes('馒头') || 
                name.includes('花卷') || 
                name.includes('面') ||
                name.includes('例汤') ||
                name.includes('+')) {
                return '主食';
            }
            
            // 汤品识别
            if (name.includes('汤') || 
                name.includes('炖') || 
                name.includes('羹') ||
                name.includes('肉蓉') ||
                name.includes('龙骨') ||
                name.includes('虫草花')) {
                return '汤品';
            }
            
            // 默认主菜
            return '主菜';
        }
        
        // ===== 从工作表名称提取日期 =====
        function extractDateFromSheetName(sheetName) {
            // 格式如: 1.12-7周日
            var match = sheetName.match(/(\d+)\.(\d+)-(\d+)周/);
            if (match) {
                var sheetIndex = parseInt(match[1]);
                var month = parseInt(match[2]);
                var day = parseInt(match[3]);
                
                // 获取当前年份
                var now = new Date();
                var year = now.getFullYear();
                
                // 检查月份是否合理（如果工作表是12月但现在是1月，可能是去年的12月）
                if (month > now.getMonth() + 2) { // +2是考虑到可能有误差
                    year = now.getFullYear() - 1;
                }
                
                return year + '-' + (month < 10 ? '0' + month : month) + '-' + (day < 10 ? '0' + day : day);
            }
            
            // 尝试其他格式
            match = sheetName.match(/(\d+)-(\d+)/);
            if (match) {
                var month = parseInt(match[1]);
                var day = parseInt(match[2]);
                var now = new Date();
                var year = now.getFullYear();
                
                if (month > now.getMonth() + 2) {
                    year = now.getFullYear() - 1;
                }
                
                return year + '-' + (month < 10 ? '0' + month : month) + '-' + (day < 10 ? '0' + day : day);
            }
            
            return null;
        }
        
        // ===== 标签切换功能 =====
        function switchTab(tabId) {
            var tabs = document.querySelectorAll('.tab');
            tabs.forEach(function(tab) {
                tab.classList.remove('active');
            });
            
            var tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(function(content) {
                content.classList.remove('active');
            });
            
            var activeTab = document.querySelector('[onclick="switchTab(\'' + tabId + '\')"]');
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            var activeContent = document.getElementById(tabId);
            if (activeContent) {
                activeContent.classList.add('active');
            }
        }
        
        // ===== 全屏功能 =====
        function toggleFullscreen() {
            if (!isFullscreen) {
                enterFullscreen();
            } else {
                exitFullscreen();
            }
        }
        
        function enterFullscreen() {
            document.body.classList.add('fullscreen');
            
            if (document.body.requestFullscreen) {
                document.body.requestFullscreen().then(function() {
                    isFullscreen = true;
                    updateFullscreenButton();
                    showMessage('已进入全屏模式', 'info');
                }).catch(function(err) {
                    console.log('全屏错误:', err);
                    showMessage('全屏请求被拒绝: ' + err.message, 'error');
                    document.body.classList.remove('fullscreen');
                });
            } else if (document.body.webkitRequestFullscreen) {
                document.body.webkitRequestFullscreen();
                isFullscreen = true;
                updateFullscreenButton();
                showMessage('已进入全屏模式', 'info');
            } else if (document.body.msRequestFullscreen) {
                document.body.msRequestFullscreen();
                isFullscreen = true;
                updateFullscreenButton();
                showMessage('已进入全屏模式', 'info');
            } else if (document.body.mozRequestFullScreen) {
                document.body.mozRequestFullScreen();
                isFullscreen = true;
                updateFullscreenButton();
                showMessage('已进入全屏模式', 'info');
            } else {
                document.body.style.position = 'fixed';
                document.body.style.top = '0';
                document.body.style.left = '0';
                document.body.style.width = '100%';
                document.body.style.height = '100%';
                document.body.style.margin = '0';
                document.body.style.padding = '0';
                document.body.style.zIndex = '9999';
                document.body.style.background = '#f0f0f0';
                document.body.style.overflow = 'auto';
                
                document.querySelector('.container').style.margin = '0';
                document.querySelector('.container').style.borderRadius = '0';
                document.querySelector('.container').style.height = '100vh';
                document.querySelector('.menu-container').style.maxHeight = 'calc(100vh - 100px)';
                
                isFullscreen = true;
                updateFullscreenButton();
                showMessage('已进入模拟全屏模式', 'info');
            }
        }
        
        function exitFullscreen() {
            document.body.classList.remove('fullscreen');
            
            if (document.exitFullscreen) {
                document.exitFullscreen().then(function() {
                    isFullscreen = false;
                    updateFullscreenButton();
                    resetFullscreenStyles();
                    showMessage('已退出全屏模式', 'info');
                });
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
                isFullscreen = false;
                updateFullscreenButton();
                resetFullscreenStyles();
                showMessage('已退出全屏模式', 'info');
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
                isFullscreen = false;
                updateFullscreenButton();
                resetFullscreenStyles();
                showMessage('已退出全屏模式', 'info');
            } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
                isFullscreen = false;
                updateFullscreenButton();
                resetFullscreenStyles();
                showMessage('已退出全屏模式', 'info');
            } else {
                resetFullscreenStyles();
                isFullscreen = false;
                updateFullscreenButton();
                showMessage('已退出全屏模式', 'info');
            }
        }
        
        function resetFullscreenStyles() {
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.left = '';
            document.body.style.width = '';
            document.body.style.height = '';
            document.body.style.margin = '';
            document.body.style.padding = '5px';
            document.body.style.zIndex = '';
            document.body.style.background = '';
            document.body.style.overflow = '';
            
            document.querySelector('.container').style.margin = '';
            document.querySelector('.container').style.borderRadius = '';
            document.querySelector('.container').style.height = '';
            document.querySelector('.menu-container').style.maxHeight = '';
        }
        
        function updateFullscreenButton() {
            if (fullscreenBtn) {
                if (isFullscreen) {
                    fullscreenBtn.textContent = '退出全屏';
                    fullscreenBtn.style.background = '#e74c3c';
                } else {
                    fullscreenBtn.textContent = '全屏显示';
                    fullscreenBtn.style.background = '#4a90e2';
                }
            }
        }
        
        // 监听全屏变化事件
        document.addEventListener('fullscreenchange', function() {
            isFullscreen = !!document.fullscreenElement;
            if (isFullscreen) {
                document.body.classList.add('fullscreen');
            } else {
                document.body.classList.remove('fullscreen');
                resetFullscreenStyles();
            }
            updateFullscreenButton();
        });
        
        document.addEventListener('webkitfullscreenchange', function() {
            isFullscreen = !!document.webkitFullscreenElement;
            if (isFullscreen) {
                document.body.classList.add('fullscreen');
            } else {
                document.body.classList.remove('fullscreen');
                resetFullscreenStyles();
            }
            updateFullscreenButton();
        });
        
        document.addEventListener('mozfullscreenchange', function() {
            isFullscreen = !!document.mozFullScreenElement;
            if (isFullscreen) {
                document.body.classList.add('fullscreen');
            } else {
                document.body.classList.remove('fullscreen');
                resetFullscreenStyles();
            }
            updateFullscreenButton();
        });
        
        document.addEventListener('MSFullscreenChange', function() {
            isFullscreen = !!document.msFullscreenElement;
            if (isFullscreen) {
                document.body.classList.add('fullscreen');
            } else {
                document.body.classList.remove('fullscreen');
                resetFullscreenStyles();
            }
            updateFullscreenButton();
        });
        
        // ===== 数据管理 =====
        function loadData() {
            try {
                var saved = localStorage.getItem('menu_data');
                if (saved) {
                    menuData = JSON.parse(saved);
                } else {
                    createSampleData();
                }
                
                var savedPassword = localStorage.getItem('admin_password');
                if (savedPassword) {
                    ADMIN_KEY = savedPassword;
                }
                
                var savedUrl = localStorage.getItem('excel_url');
                if (savedUrl) {
                    document.getElementById('custom-url').value = savedUrl;
                } else {
                    document.getElementById('custom-url').value = '';
                }
                
                var savedLanFiles = localStorage.getItem('lan_files_history');
                if (savedLanFiles) {
                    recentLanFiles = JSON.parse(savedLanFiles);
                }
                
                var savedLanPath = localStorage.getItem('lan_file_path');
                if (savedLanPath) {
                    lanPathInput.value = savedLanPath;
                }
                
                return true;
            } catch (e) {
                showMessage('加载数据失败: ' + e.message, 'error');
                createSampleData();
                return false;
            }
        }
        
        function saveData() {
            try {
                localStorage.setItem('menu_data', JSON.stringify(menuData));
                return true;
            } catch (e) {
                showMessage('保存数据失败', 'error');
                return false;
            }
        }
        
        function saveLanHistory() {
            try {
                localStorage.setItem('lan_files_history', JSON.stringify(recentLanFiles));
            } catch (e) {
                console.error('保存局域网历史失败:', e);
            }
        }
        
        function createSampleData() {
            var today = getTodayString();
            menuData = {
                [today]: {
                    "主菜": [
                        { name: "红烧肉", price: 12 },
                        { name: "清蒸鱼", price: 15 },
                        { name: "青椒炒猪肝", price: 10 },
                        { name: "宫保鸡丁", price: 11 }
                    ],
                    "素菜": [
                        { name: "芹菜炒豆干", price: 4 },
                        { name: "麻婆豆腐", price: 5 },
                        { name: "蒜蓉西兰花", price: 6 }
                    ],
                    "主食": [
                        { name: "米饭", price: 2 },
                        { name: "馒头", price: 1 },
                        { name: "花卷", price: 1 }
                    ],
                    "汤品": [
                        { name: "紫菜蛋花汤", price: 3 },
                        { name: "西红柿鸡蛋汤", price: 3 },
                        { name: "酸辣汤", price: 4 }
                    ]
                }
            };
            saveData();
        }
        
        // ===== 菜单显示 =====
        function showMenu(date) {
            currentDate = date;
            currentDateEl.textContent = formatDate(date);
            if (dateSelector) dateSelector.value = date;
            
            if (!menuData[date]) {
                menuContainer.innerHTML = '<div class="no-menu">该日期暂无菜单数据</div>';
                return;
            }
            
            var html = '';
            var categories = menuData[date];
            
            html += '<div class="menu-grid">';
            
            for (var i = 0; i < FIXED_CATEGORIES.length; i++) {
                var category = FIXED_CATEGORIES[i];
                var items = categories[category] || [];
                
                html += '<div class="category-column">';
                html += '<h3 class="category-title">' + category + '</h3>';
                html += '<div class="category-items">';
                
                if (items.length === 0) {
                    html += '<div style="text-align:center;color:#777;padding:15px;font-size:0.85rem;">暂无菜品</div>';
                } else {
                    for (var j = 0; j < items.length; j++) {
                        var item = items[j];
                        html += '<div class="menu-item">';
                        html += '<span class="item-name">' + item.name + '</span>';
                        html += '<span class="item-price">' + item.price + '元</span>';
                        
                        if (isAdmin) {
                            html += '<button class="btn" style="margin-left:4px;padding:1px 5px;font-size:0.7rem;" onclick="editItem(\'' + date + '\', \'' + category + '\', ' + j + ')">编辑</button>';
                        }
                        
                        html += '</div>';
                    }
                }
                
                html += '</div></div>';
            }
            
            html += '</div>';
            
            menuContainer.innerHTML = html;
            
            setTimeout(function() {
                adjustLayout();
            }, 100);
        }
        
        function adjustLayout() {
            var menuGrid = document.querySelector('.menu-grid');
            if (menuGrid) {
                var containerWidth = menuContainer.offsetWidth;
                if (containerWidth < 800) {
                    menuGrid.style.minWidth = '600px';
                } else {
                    menuGrid.style.minWidth = '800px';
                }
            }
        }
        
        window.addEventListener('resize', adjustLayout);
        
        function editItem(date, category, index) {
            var item = menuData[date][category][index];
            var newName = prompt('修改菜品名称:', item.name);
            if (newName === null) return;
            
            var newPrice = prompt('修改价格:', item.price);
            if (newPrice === null) return;
            
            newPrice = parseFloat(newPrice);
            if (isNaN(newPrice)) {
                showMessage('价格必须是数字', 'error');
                return;
            }
            
            item.name = newName;
            item.price = newPrice;
            
            if (saveData()) {
                showMenu(date);
                showMessage('修改成功');
            }
        }
        
        // ===== 管理员功能 =====
        function showPasswordModal() {
            showModal('password-modal');
            document.getElementById('password-input').focus();
        }
        
        function checkPassword() {
            var input = document.getElementById('password-input').value;
            if (input === ADMIN_KEY) {
                isAdmin = true;
                adminControls.style.display = 'block';
                adminBtn.style.display = 'none';
                exitBtn.style.display = 'inline-block';
                hideModal('password-modal');
                showMenu(currentDate);
                showMessage('管理员登录成功');
            } else {
                showMessage('密码错误', 'error');
                document.getElementById('password-input').value = '';
                document.getElementById('password-input').focus();
            }
        }
        
        function exitAdmin() {
            isAdmin = false;
            adminControls.style.display = 'none';
            adminBtn.style.display = 'inline-block';
            exitBtn.style.display = 'none';
            showMenu(currentDate);
            showMessage('已退出管理员模式');
        }
        
        function showChangePassword() {
            if (!isAdmin) {
                showPasswordModal();
                return;
            }
            showModal('change-password-modal');
            document.getElementById('old-password').focus();
        }
        
        function saveNewPassword() {
            var oldPass = document.getElementById('old-password').value;
            var newPass = document.getElementById('new-password').value;
            
            if (oldPass !== ADMIN_KEY) {
                showMessage('原密码错误', 'error');
                return;
            }
            
            if (newPass.length < 4) {
                showMessage('新密码至少4位', 'error');
                return;
            }
            
            ADMIN_KEY = newPass;
            localStorage.setItem('admin_password', newPass);
            hideModal('change-password-modal');
            showMessage('密码修改成功');
        }
        
        // ===== Excel操作 =====
        function importExcel() {
            if (!isAdmin) {
                showPasswordModal();
                return;
            }
            
            var input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx, .xls';
            
            input.onchange = function(e) {
                var file = e.target.files[0];
                if (!file) return;
                
                processExcelFile(file);
            };
            
            input.click();
        }
        
        // ===== 修复：处理周菜单Excel文件 =====
        function processExcelFile(file) {
            if (!window.XLSX) {
                showMessage('Excel库加载失败，请检查网络', 'error');
                return;
            }
            
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var data = new Uint8Array(e.target.result);
                    var workbook = window.XLSX.read(data, { type: 'array' });
                    
                    // 统计导入的工作表数量
                    var importedSheets = 0;
                    var totalSheets = 0;
                    
                    // 遍历所有工作表
                    for (var sheetIndex = 0; sheetIndex < workbook.SheetNames.length; sheetIndex++) {
                        var sheetName = workbook.SheetNames[sheetIndex];
                        var worksheet = workbook.Sheets[sheetName];
                        
                        // 跳过汇总工作表
                        if (sheetName === '周汇总' || sheetName.includes('汇总')) {
                            continue;
                        }
                        
                        totalSheets++;
                        
                        // 尝试从工作表名称提取日期
                        var dateStr = extractDateFromSheetName(sheetName);
                        
                        // 如果没有从工作表名称提取到日期，使用第一个工作表作为当前日期
                        if (!dateStr && sheetIndex === 0) {
                            dateStr = getTodayString();
                        }
                        
                        if (!dateStr) {
                            console.warn('无法从工作表名称提取日期:', sheetName);
                            continue;
                        }
                        
                        var jsonData = window.XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        if (jsonData && jsonData.length > 0) {
                            if (processExcelData(jsonData, dateStr)) {
                                importedSheets++;
                                console.log('成功导入工作表:', sheetName, '日期:', dateStr);
                            }
                        }
                    }
                    
                    if (importedSheets > 0) {
                        showMessage('成功导入' + importedSheets + '个工作表的菜单数据', 'info');
                        // 显示当前日期菜单
                        showMenu(currentDate);
                    } else {
                        showMessage('未能导入任何菜单数据', 'error');
                    }
                    
                } catch (error) {
                    console.error(error);
                    showMessage('导入失败: ' + error.message, 'error');
                }
            };
            
            reader.onerror = function() {
                showMessage('读取文件失败', 'error');
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function processExcelData(jsonData, dateStr) {
            var newMenu = {};
            // 初始化四个固定分类
            for (var i = 0; i < FIXED_CATEGORIES.length; i++) {
                newMenu[FIXED_CATEGORIES[i]] = [];
            }
            
            var processedCount = 0;
            
            // 从第2行开始（跳过标题行）
            for (var i = 1; i < jsonData.length; i++) {
                var row = jsonData[i];
                if (row && row.length >= 3) {
                    var originalCategory = String(row[0] || '').trim();
                    var name = String(row[1] || '').trim();
                    var price = row[2];
                    
                    // 跳过空行和标题行
                    if (!name || name === '菜品名称' || name === '名称') continue;
                    if (originalCategory === '类别' || originalCategory === '分类') continue;
                    
                    // 智能分类识别
                    var category = classifyMenuItem(name);
                    
                    // 如果原始分类是有效的，优先使用原始分类
                    if (originalCategory && FIXED_CATEGORIES.includes(originalCategory)) {
                        category = originalCategory;
                    }
                    
                    // 确保分类存在
                    if (!newMenu[category]) {
                        newMenu[category] = [];
                    }
                    
                    // 转换为数字价格
                    var priceNum = parseFloat(price);
                    if (isNaN(priceNum)) {
                        var priceMatch = String(price).match(/(\d+(\.\d+)?)/);
                        priceNum = priceMatch ? parseFloat(priceMatch[0]) : 0;
                    }
                    
                    // 添加到菜单
                    newMenu[category].push({
                        name: name,
                        price: priceNum || 0
                    });
                    
                    processedCount++;
                }
            }
            
            // 保存到菜单数据
            menuData[dateStr] = newMenu;
            
            // 保存数据
            if (saveData()) {
                console.log('处理数据成功，日期:', dateStr, '菜品数:', processedCount);
                return true;
            } else {
                throw new Error('保存数据失败');
            }
        }
        
        function exportExcel() {
            if (!isAdmin) {
                showPasswordModal();
                return;
            }
            
            if (!window.XLSX) {
                showMessage('Excel库加载失败，请检查网络', 'error');
                return;
            }
            
            var menu = menuData[currentDate];
            if (!menu) {
                showMessage('没有菜单数据', 'error');
                return;
            }
            
            try {
                var data = [['类别', '菜品名称', '价格(元)']];
                
                for (var i = 0; i < FIXED_CATEGORIES.length; i++) {
                    var category = FIXED_CATEGORIES[i];
                    var items = menu[category] || [];
                    
                    for (var j = 0; j < items.length; j++) {
                        var item = items[j];
                        data.push([category, item.name, item.price]);
                    }
                }
                
                var ws = window.XLSX.utils.aoa_to_sheet(data);
                var wb = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(wb, ws, '菜单');
                
                var fileName = '菜单_' + currentDate + '.xlsx';
                window.XLSX.writeFile(wb, fileName);
                
                showMessage('导出成功: ' + fileName);
            } catch (error) {
                showMessage('导出失败: ' + error.message, 'error');
            }
        }
        
        // ===== 导出周菜单功能 =====
        function exportWeekMenu() {
            if (!isAdmin) {
                showPasswordModal();
                return;
            }
            
            if (!window.XLSX) {
                showMessage('Excel库加载失败，请检查网络', 'error');
                return;
            }
            
            // 设置默认起始日期为今天
            weekStartDateInput.value = currentDate;
            updateWeekDateRange();
            
            // 监听日期变化
            weekStartDateInput.onchange = updateWeekDateRange;
            
            showModal('week-export-modal');
        }
        
        function updateWeekDateRange() {
            var startDate = weekStartDateInput.value;
            if (!startDate) return;
            
            var weekDates = getWeekDates(startDate);
            var startDateObj = new Date(weekDates[0]);
            var endDateObj = new Date(weekDates[6]);
            
            var formatDateStr = function(date) {
                var month = date.getMonth() + 1;
                var day = date.getDate();
                return month + '月' + day + '日';
            };
            
            weekDateRangeSpan.textContent = formatDateStr(startDateObj) + ' - ' + formatDateStr(endDateObj);
        }
        
        function confirmExportWeekMenu() {
            var startDate = weekStartDateInput.value;
            if (!startDate) {
                showMessage('请选择起始日期', 'error');
                return;
            }
            
            var weekDates = getWeekDates(startDate);
            
            // 检查是否有数据
            var hasData = false;
            for (var i = 0; i < weekDates.length; i++) {
                if (menuData[weekDates[i]]) {
                    hasData = true;
                    break;
                }
            }
            
            if (!hasData) {
                showMessage('所选日期范围内没有菜单数据', 'error');
                return;
            }
            
            try {
                var workbook = window.XLSX.utils.book_new();
                
                // 为每周的每一天创建一个工作表
                for (var i = 0; i < weekDates.length; i++) {
                    var date = weekDates[i];
                    var menu = menuData[date];
                    
                    // 使用安全的表名
                    var sheetName = getSafeSheetName(date, i);
                    
                    var data = [['类别', '菜品名称', '价格(元)']];
                    
                    if (menu) {
                        for (var j = 0; j < FIXED_CATEGORIES.length; j++) {
                            var category = FIXED_CATEGORIES[j];
                            var items = menu[category] || [];
                            
                            for (var k = 0; k < items.length; k++) {
                                var item = items[k];
                                data.push([category, item.name, item.price]);
                            }
                        }
                    }
                    
                    var ws = window.XLSX.utils.aoa_to_sheet(data);
                    window.XLSX.utils.book_append_sheet(workbook, ws, sheetName);
                }
                
                // 添加一个汇总工作表
                var summaryData = [['日期', '星期', '主菜品数', '素菜品数', '主食品数', '汤品数', '总菜品数']];
                
                for (var i = 0; i < weekDates.length; i++) {
                    var date = weekDates[i];
                    var dateObj = new Date(date);
                    var weekdays = ['日', '一', '二', '三', '四', '五', '六'];
                    var weekday = weekdays[dateObj.getDay()];
                    var menu = menuData[date];
                    
                    var mainCount = 0, vegCount = 0, stapleCount = 0, soupCount = 0;
                    
                    if (menu) {
                        mainCount = menu['主菜'] ? menu['主菜'].length : 0;
                        vegCount = menu['素菜'] ? menu['素菜'].length : 0;
                        stapleCount = menu['主食'] ? menu['主食'].length : 0;
                        soupCount = menu['汤品'] ? menu['汤品'].length : 0;
                    }
                    
                    var totalCount = mainCount + vegCount + stapleCount + soupCount;
                    
                    summaryData.push([
                        date,
                        '星期' + weekday,
                        mainCount,
                        vegCount,
                        stapleCount,
                        soupCount,
                        totalCount
                    ]);
                }
                
                var summaryWs = window.XLSX.utils.aoa_to_sheet(summaryData);
                window.XLSX.utils.book_append_sheet(workbook, summaryWs, '周汇总');
                
                // 生成文件名
                var startDateObj = new Date(weekDates[0]);
                var endDateObj = new Date(weekDates[6]);
                var fileName = '周菜单_' + 
                    (startDateObj.getMonth() + 1) + '月' + startDateObj.getDate() + '日-' +
                    (endDateObj.getMonth() + 1) + '月' + endDateObj.getDate() + '日.xlsx';
                
                window.XLSX.writeFile(workbook, fileName);
                
                hideModal('week-export-modal');
                showMessage('周菜单导出成功: ' + fileName);
                
            } catch (error) {
                console.error('周菜单导出错误:', error);
                showMessage('周菜单导出失败: ' + error.message, 'error');
            }
        }
        
        // ===== 更新菜单模态框 =====
        function showUpdateModal() {
            showModal('update-modal');
            switchTab('online-tab');
            urlTestDiv.style.display = 'none';
            progressContainer.style.display = 'none';
            lanUrlTestDiv.style.display = 'none';
            lanProgressContainer.style.display = 'none';
        }
        
        // ===== 在线更新功能 =====
        function getExcelUrl() {
            var customUrl = document.getElementById('custom-url').value.trim();
            return customUrl || DEFAULT_EXCEL_URL;
        }
        
        // ===== 修复CORS问题 =====
        function testCustomUrl() {
            var url = getExcelUrl();
            if (!url) {
                showMessage('请输入Excel文件链接', 'error');
                return;
            }
            
            urlTestDiv.style.display = 'block';
            testResultDiv.innerHTML = '<div style="margin:5px 0;">测试连接中... <span class="url-status loading">测试中</span></div>';
            
            // 使用代理服务或直接尝试下载
            setTimeout(function() {
                // 创建隐藏的iframe来测试
                var iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = url;
                iframe.onload = function() {
                    testResultDiv.innerHTML = '<div style="margin:5px 0;">连接成功! <span class="url-status success">可用</span></div>';
                    showMessage('链接测试成功', 'info');
                    document.body.removeChild(iframe);
                };
                iframe.onerror = function() {
                    testResultDiv.innerHTML = '<div style="margin:5px 0;">连接失败 <span class="url-status error-status">不可用</span></div>';
                    showMessage('链接测试失败', 'error');
                    document.body.removeChild(iframe);
                };
                document.body.appendChild(iframe);
            }, 500);
        }
        
        function saveCustomUrl() {
            var url = document.getElementById('custom-url').value.trim();
            if (url) {
                localStorage.setItem('excel_url', url);
                showMessage('自定义链接已保存', 'info');
            } else {
                localStorage.removeItem('excel_url');
                showMessage('已清除自定义链接', 'info');
            }
        }
        
        function resetToDefaultUrl() {
            if (confirm('确定要重置为默认链接吗？')) {
                document.getElementById('custom-url').value = '';
                localStorage.removeItem('excel_url');
                showMessage('已重置为默认链接', 'info');
            }
        }
        
        // ===== 核心修复：在线更新自动下载并导入（绕过CORS）=====
        function startOnlineUpdate() {
            var url = getExcelUrl();
            
            if (!url) {
                showMessage('请输入Excel文件链接', 'error');
                return;
            }
            
            // 显示进度条
            showProgress(0, '开始下载...');
            
            // 方法1：使用XMLHttpRequest并设置适当的头部
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.responseType = 'arraybuffer';
            xhr.timeout = 30000; // 30秒超时
            
            xhr.onprogress = function(e) {
                if (e.lengthComputable) {
                    var percent = Math.round((e.loaded / e.total) * 100);
                    showProgress(percent, '下载中... ' + percent + '%');
                }
            };
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    showProgress(90, '下载完成，正在解析...');
                    
                    try {
                        // 解析Excel数据
                        var data = new Uint8Array(xhr.response);
                        var workbook = window.XLSX.read(data, { type: 'array' });
                        
                        if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                            throw new Error('Excel文件中没有工作表');
                        }
                        
                        // 导入所有工作表
                        var importedSheets = 0;
                        var totalSheets = 0;
                        
                        for (var sheetIndex = 0; sheetIndex < workbook.SheetNames.length; sheetIndex++) {
                            var sheetName = workbook.SheetNames[sheetIndex];
                            var worksheet = workbook.Sheets[sheetName];
                            
                            // 跳过汇总工作表
                            if (sheetName === '周汇总' || sheetName.includes('汇总')) {
                                continue;
                            }
                            
                            totalSheets++;
                            
                            // 尝试从工作表名称提取日期
                            var dateStr = extractDateFromSheetName(sheetName);
                            
                            // 如果没有从工作表名称提取到日期，使用第一个工作表作为当前日期
                            if (!dateStr && sheetIndex === 0) {
                                dateStr = getTodayString();
                            }
                            
                            if (!dateStr) {
                                console.warn('无法从工作表名称提取日期:', sheetName);
                                continue;
                            }
                            
                            var jsonData = window.XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                            
                            if (jsonData && jsonData.length > 0) {
                                if (processExcelData(jsonData, dateStr)) {
                                    importedSheets++;
                                }
                            }
                        }
                        
                        if (importedSheets > 0) {
                            showProgress(100, '更新完成！');
                            setTimeout(function() {
                                progressContainer.style.display = 'none';
                                showMessage('成功导入' + importedSheets + '个工作表的菜单数据', 'info');
                                hideModal('update-modal');
                                // 显示当前日期菜单
                                showMenu(currentDate);
                            }, 1000);
                        } else {
                            throw new Error('未能导入任何菜单数据');
                        }
                        
                    } catch (error) {
                        progressContainer.style.display = 'none';
                        showMessage('解析失败: ' + error.message, 'error');
                    }
                } else {
                    progressContainer.style.display = 'none';
                    showMessage('下载失败: HTTP ' + xhr.status, 'error');
                }
            };
            
            xhr.onerror = function() {
                progressContainer.style.display = 'none';
                showMessage('网络错误，下载失败。可能是CORS问题，请尝试其他方法。', 'error');
            };
            
            xhr.ontimeout = function() {
                progressContainer.style.display = 'none';
                showMessage('连接超时，下载失败', 'error');
            };
            
            // 尝试发送请求
            try {
                xhr.send();
            } catch (e) {
                // 如果XHR失败，尝试使用fetch
                progressContainer.style.display = 'none';
                showMessage('尝试备用方法下载...', 'info');
                downloadViaProxy(url);
            }
        }
        
        // 备用方法：使用iframe下载
        function downloadViaProxy(url) {
            showProgress(30, '正在使用备用方法下载...');
            
            // 创建一个隐藏的iframe来下载文件
            var iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = url;
            
            iframe.onload = function() {
                showProgress(70, '文件已下载，正在尝试读取...');
                
                // 从iframe的contentDocument中读取数据
                setTimeout(function() {
                    try {
                        var doc = iframe.contentDocument || iframe.contentWindow.document;
                        var blob = null;
                        
                        // 尝试获取blob数据
                        if (doc.body && doc.body.innerHTML) {
                            // 这里可能需要根据实际情况调整
                            showProgress(90, '正在处理数据...');
                            
                            // 提示用户手动导入
                            setTimeout(function() {
                                progressContainer.style.display = 'none';
                                document.body.removeChild(iframe);
                                
                                if (confirm('文件下载成功！但需要手动导入。\n\n是否要现在导入下载的文件？')) {
                                    manualImport();
                                } else {
                                    showMessage('文件已下载，请稍后手动导入', 'info');
                                }
                            }, 1000);
                        } else {
                            throw new Error('无法读取文件内容');
                        }
                    } catch (error) {
                        progressContainer.style.display = 'none';
                        document.body.removeChild(iframe);
                        showMessage('读取文件失败: ' + error.message, 'error');
                    }
                }, 2000);
            };
            
            iframe.onerror = function() {
                progressContainer.style.display = 'none';
                document.body.removeChild(iframe);
                showMessage('下载失败，请检查链接是否正确', 'error');
            };
            
            document.body.appendChild(iframe);
        }
        
        function downloadExcelFile() {
            var url = getExcelUrl();
            
            if (!url) {
                showMessage('请输入Excel文件链接', 'error');
                return;
            }
            
            // 直接在新窗口打开链接
            window.open(url, '_blank');
            showMessage('已在浏览器中打开Excel文件', 'info');
        }
        
        function manualImport() {
            var input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx, .xls';
            
            input.onchange = function(e) {
                var file = e.target.files[0];
                if (!file) return;
                
                hideModal('update-modal');
                processExcelFile(file);
            };
            
            input.click();
        }
        
        function showProgress(percent, text) {
            progressContainer.style.display = 'block';
            progressFill.style.width = percent + '%';
            progressText.textContent = text;
        }
        
        // ===== 局域网更新功能 =====
        function browseLanFile() {
            showMessage('提示: 在Windows中，可以输入类似 \\\\计算机名\\共享文件夹\\菜单.xlsx 的路径', 'info');
        }
        
        function selectLanFile() {
            var input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx, .xls';
            
            input.onchange = function(e) {
                var file = e.target.files[0];
                if (!file) return;
                
                var filePath = file.path || file.name;
                lanPathInput.value = filePath;
                
                addToLanHistory(filePath, file.name);
                
                showMessage('已选择文件: ' + file.name, 'info');
            };
            
            input.click();
        }
        
        function testLanPath() {
            var path = lanPathInput.value.trim();
            if (!path) {
                showMessage('请输入局域网文件路径', 'error');
                return;
            }
            
            lanUrlTestDiv.style.display = 'block';
            lanTestResultDiv.innerHTML = '<div style="margin:5px 0;">测试路径中... <span class="url-status loading">测试中</span></div>';
            
            fetch(path, { 
                method: 'HEAD',
                mode: 'no-cors'
            }).then(function(response) {
                lanTestResultDiv.innerHTML = '<div style="margin:5px 0;">路径有效（可能） <span class="url-status success">可用</span></div>';
                showMessage('路径测试完成（实际可用性需加载测试）', 'info');
            }).catch(function(error) {
                lanTestResultDiv.innerHTML = '<div style="margin:5px 0;">路径访问失败: ' + error.message + ' <span class="url-status error-status">不可用</span></div>';
                showMessage('路径访问失败: ' + error.message, 'error');
            });
        }
        
        function saveLanPath() {
            var path = lanPathInput.value.trim();
            if (path) {
                localStorage.setItem('lan_file_path', path);
                showMessage('局域网路径已保存', 'info');
                
                var fileName = path.split('\\').pop() || path.split('/').pop();
                addToLanHistory(path, fileName);
            } else {
                localStorage.removeItem('lan_file_path');
                showMessage('已清除局域网路径', 'info');
            }
        }
        
        function addToLanHistory(path, name) {
            for (var i = 0; i < recentLanFiles.length; i++) {
                if (recentLanFiles[i].path === path) {
                    var existing = recentLanFiles.splice(i, 1)[0];
                    recentLanFiles.unshift(existing);
                    saveLanHistory();
                    return;
                }
            }
            
            recentLanFiles.unshift({
                path: path,
                name: name,
                date: new Date().toLocaleString()
            });
            
            if (recentLanFiles.length > 10) {
                recentLanFiles = recentLanFiles.slice(0, 10);
            }
            
            saveLanHistory();
        }
        
        function loadLanFile() {
            var path = lanPathInput.value.trim();
            if (!path) {
                showMessage('请输入局域网文件路径', 'error');
                return;
            }
            
            showLanProgress(10, '正在读取文件...');
            
            setTimeout(function() {
                showLanProgress(50, '请选择文件...');
                
                var input = document.createElement('input');
                input.type = 'file';
                input.accept = '.xlsx, .xls';
                
                input.onchange = function(e) {
                    var file = e.target.files[0];
                    if (!file) {
                        showLanProgress(0, '已取消');
                        setTimeout(function() {
                            lanProgressContainer.style.display = 'none';
                        }, 500);
                        return;
                    }
                    
                    showLanProgress(70, '处理文件中...');
                    
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            var data = new Uint8Array(e.target.result);
                            var workbook = window.XLSX.read(data, { type: 'array' });
                            
                            // 导入所有工作表
                            var importedSheets = 0;
                            var totalSheets = 0;
                            
                            for (var sheetIndex = 0; sheetIndex < workbook.SheetNames.length; sheetIndex++) {
                                var sheetName = workbook.SheetNames[sheetIndex];
                                var worksheet = workbook.Sheets[sheetName];
                                
                                // 跳过汇总工作表
                                if (sheetName === '周汇总' || sheetName.includes('汇总')) {
                                    continue;
                                }
                                
                                totalSheets++;
                                
                                // 尝试从工作表名称提取日期
                                var dateStr = extractDateFromSheetName(sheetName);
                                
                                // 如果没有从工作表名称提取到日期，使用第一个工作表作为当前日期
                                if (!dateStr && sheetIndex === 0) {
                                    dateStr = getTodayString();
                                }
                                
                                if (!dateStr) {
                                    console.warn('无法从工作表名称提取日期:', sheetName);
                                    continue;
                                }
                                
                                var jsonData = window.XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                                
                                if (jsonData && jsonData.length > 0) {
                                    if (processExcelData(jsonData, dateStr)) {
                                        importedSheets++;
                                    }
                                }
                            }
                            
                            if (importedSheets > 0) {
                                var fileName = path.split('\\').pop() || path.split('/').pop() || file.name;
                                addToLanHistory(path, fileName);
                                
                                showLanProgress(100, '更新完成！');
                                
                                setTimeout(function() {
                                    lanProgressContainer.style.display = 'none';
                                    showMessage('成功导入' + importedSheets + '个工作表的菜单数据', 'info');
                                    hideModal('update-modal');
                                    // 显示当前日期菜单
                                    showMenu(currentDate);
                                }, 1000);
                            } else {
                                lanProgressContainer.style.display = 'none';
                                showMessage('未能导入任何菜单数据', 'error');
                            }
                            
                        } catch (error) {
                            lanProgressContainer.style.display = 'none';
                            showMessage('解析Excel失败: ' + error.message, 'error');
                        }
                    };
                    
                    reader.onerror = function() {
                        lanProgressContainer.style.display = 'none';
                        showMessage('读取文件失败', 'error');
                    };
                    
                    reader.readAsArrayBuffer(file);
                };
                
                input.click();
                
            }, 500);
        }
        
        function openLanFile() {
            var path = lanPathInput.value.trim();
            if (!path) {
                showMessage('请输入文件路径', 'error');
                return;
            }
            
            try {
                if (path.startsWith('\\\\')) {
                    window.open('file:' + path, '_blank');
                } else {
                    window.open('file://' + path, '_blank');
                }
                showMessage('尝试打开文件位置', 'info');
            } catch (error) {
                showMessage('无法打开文件位置: ' + error.message, 'error');
            }
        }
        
        function showRecentLanFiles() {
            showModal('recent-files-modal');
            renderRecentFiles();
        }
        
        function renderRecentFiles() {
            if (recentLanFiles.length === 0) {
                noRecentFiles.style.display = 'block';
                recentFilesList.innerHTML = '<div style="text-align:center;padding:20px;color:#777;">暂无最近使用的文件</div>';
                return;
            }
            
            noRecentFiles.style.display = 'none';
            var html = '';
            
            for (var i = 0; i < recentLanFiles.length; i++) {
                var file = recentLanFiles[i];
                html += '<div style="padding:10px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;">';
                html += '<div>';
                html += '<div style="font-weight:bold;font-size:0.9rem;">' + file.name + '</div>';
                html += '<div style="font-size:0.8rem;color:#777;margin-top:3px;">' + file.path + '</div>';
                html += '<div style="font-size:0.75rem;color:#999;margin-top:2px;">' + file.date + '</div>';
                html += '</div>';
                html += '<div>';
                html += '<button class="btn" style="padding:3px 8px;font-size:0.75rem;margin-left:5px;" onclick="useRecentFile(' + i + ')">使用</button>';
                html += '<button class="btn" style="padding:3px 8px;font-size:0.75rem;margin-left:5px;background:#e74c3c;" onclick="removeRecentFile(' + i + ')">删除</button>';
                html += '</div>';
                html += '</div>';
            }
            
            recentFilesList.innerHTML = html;
        }
        
        function useRecentFile(index) {
            if (index >= 0 && index < recentLanFiles.length) {
                var file = recentLanFiles[index];
                lanPathInput.value = file.path;
                hideModal('recent-files-modal');
                showMessage('已选择文件: ' + file.name, 'info');
            }
        }
        
        function removeRecentFile(index) {
            if (index >= 0 && index < recentLanFiles.length) {
                recentLanFiles.splice(index, 1);
                saveLanHistory();
                renderRecentFiles();
                showMessage('已删除记录', 'info');
            }
        }
        
        function clearLanHistory() {
            if (confirm('确定要清除所有历史记录吗？')) {
                recentLanFiles = [];
                localStorage.removeItem('lan_files_history');
                if (recentFilesList) {
                    renderRecentFiles();
                }
                showMessage('已清除所有历史记录', 'info');
            }
        }
        
        function showLanProgress(percent, text) {
            lanProgressContainer.style.display = 'block';
            lanProgressFill.style.width = percent + '%';
            lanProgressText.textContent = text;
        }
        
        // ===== 其他功能 =====
        function showToday() {
            var today = getTodayString();
            showMenu(today);
            showMessage('已显示今日菜单', 'info');
        }
        
        function changeDate(date) {
            if (date) {
                showMenu(date);
            }
        }
        
        function forgotPassword() {
            var key = prompt('请输入系统密钥重置密码:');
            if (key === SYSTEM_KEY) {
                ADMIN_KEY = 'admin123';
                localStorage.setItem('admin_password', 'admin123');
                showMessage('密码已重置为: admin123', 'info');
            } else if (key) {
                showMessage('密钥错误', 'error');
            }
        }
        
        // ===== 初始化 =====
        function init() {
            showMessage('正在加载系统...', 'info');
            
            if (!window.XLSX) {
                showMessage('注意: Excel功能需要网络连接', 'error');
                var script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
                script.onload = function() {
                    showMessage('Excel库加载成功', 'info');
                };
                script.onerror = function() {
                    showMessage('Excel库加载失败，部分功能不可用', 'error');
                };
                document.head.appendChild(script);
            }
            
            if (!loadData()) {
                createSampleData();
            }
            
            var today = getTodayString();
            showMenu(today);
            
            document.getElementById('default-url').textContent = DEFAULT_EXCEL_URL;
            
            document.addEventListener('contextmenu', function(e) {
                if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                }
            });
            
            var longPressTimer;
            
            if (adminBtn) {
                adminBtn.addEventListener('touchstart', function() {
                    longPressTimer = setTimeout(function() {
                        forgotPassword();
                    }, 3000);
                });
                
                adminBtn.addEventListener('touchend', function() {
                    clearTimeout(longPressTimer);
                });
                
                adminBtn.addEventListener('touchmove', function() {
                    clearTimeout(longPressTimer);
                });
            }
            
            var modals = document.querySelectorAll('.modal');
            for (var i = 0; i < modals.length; i++) {
                modals[i].addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.style.display = 'none';
                    }
                });
            }
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    hideModal('password-modal');
                    hideModal('update-modal');
                    hideModal('change-password-modal');
                    hideModal('recent-files-modal');
                    hideModal('week-export-modal');
                }
            });
            
            setTimeout(function() {
                showMessage('餐厅菜单系统已加载完成');
                adjustLayout();
            }, 1000);
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>